define-command -docstring 'Toggle UI elements' -params 1.. \
toggle-highlighter %{
    try %{
        add-highlighter %arg{@}
    } catch %{
        remove-highlighter %arg{1}
    }
}
define-command -docstring 'Toggle options' -params 1.. \
toggle-option %{
    try %{
        evaluate-commands "evaluate-commands %%sh{ [ -z ""$kak_opt_%arg{2}"" ] && printf nop || printf fail }"
        set-option %arg{@}
    } catch %{
        set-option %arg{1} %arg{2} ''
    }
}

map -docstring 'Run some useful commands' global user c \
': evaluate-commands %sh{ cat "$kak_config/commands.kak" | bemenu -l 20; }<ret>'

set-option global indentwidth 4
define-command -docstring 'Rename the current session to given name, and try to daemonize them' -params 1 \
try-daemonize %{
    try %{ daemonize-session }
    rename-session %arg{1}
}
map -docstring 'Rename session' global user z ': prompt "Session Name:" %{ try-daemonize %val{text} } <ret>'

hook global WinSetOption filetype=(clojure|lisp|picolisp|racket|scheme|haskell|markdown|asciidoc) %{
    set window indentwidth 2
    map window insert <tab> <space><space>
}

hook global WinSetOption filetype=(clojure|lisp|picolisp|racket|scheme) %{
    parinfer-enable-window
    map -docstring 'Toggle parinfer mode' window user p ': parinfer-toggle-mode<ret>'
}

# Search functions shouldn't flash the screen
map global normal / ": set-register / ''<ret>/"
map global normal <a-/> ": set-register / ''<ret><a-/>"

# Xiki
define-command xiki -override %{
    evaluate-commands -save-regs wca^| -draft %{
        try %{
            execute-keys -draft 's\A +<ret>"wy'
        } catch %{
            set-register w ''
        }
        try %{
            execute-keys -draft 'h/(?S)(\n<c-r>w  .*)*$<ret>_xd'
        } catch %{
            evaluate-commands -draft %sh{
                w="$kak_reg_w"
                printf 'execute-keys %%@x_"cy@\n'
                printf 'set-register a %%reg{c}\n'
                while test -n "$w"; do
                    w="${w#'  '}"
                    printf 'execute-keys %%@<a-/>^%s(?=[^ ])<ret>@\n' "$w"
                    printf 'execute-keys %%@x_"cy@\n'
                    printf 'set-register a %%reg{c} %%reg{a}\n'
                done
            }
            set-register c %sh{
                eval set -- "$kak_quoted_reg_a"
                xiki "$@" | sed "s/^/  $kak_reg_w/"
                printf '\n'
            }
            execute-keys -draft '"cp'
        }
    }
}
map global normal <ret> 'x: xiki<ret>'
