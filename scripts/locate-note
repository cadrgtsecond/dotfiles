#!/bin/execlineb

multisubstitute {
    importas -i title 1
    importas -D . dir 2
}
if { test -n $title }
backtick -ED "" file { rg -l "^# ${title}$" . }
ifelse { test $? -ne 0 } {
    backtick -E slug {
        heredoc 0 $title
        pipeline { tr [:upper:] [:lower:] }
        tr [:space:] -
    }
    define newfile "${dir}/${slug}.md"
    foreground { redirfd -w 1 $newfile printf "# %s\\n" $title }
    printf %s $newfile
} ifelse { heredoc 0 $file backtick -E n { wc -l } test $n -gt 1 } {
    fdmove 2 1 printf "Ambiguous note"
}
printf %s $file
